stages:
  - test
  - deploy

variables:
  NODE_VERSION: "22"
  GO_VERSION: "1.25"

# ─── Frontend ─────────────────────────────────────────────

frontend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run type-check
    - npx oxlint .
    - npx eslint . --cache
    - npx vitest run
  rules:
    - changes:
        - client/**/*
        - package.json
        - package-lock.json
        - vite.config.ts
        - tsconfig*.json

# ─── Backend ──────────────────────────────────────────────

backend:test:
  stage: test
  image: golang:${GO_VERSION}-alpine
  script:
    - cd server
    - go vet ./...
    - go build ./...
  rules:
    - changes:
        - server/**/*

# ─── Deploy ──────────────────────────────────────────────
# Cloudflare Pages auto-deploys via git integration.
# Render deploy is triggered manually via deploy hook.

deploy:render:
  stage: deploy
  image: alpine:3.21
  script:
    - apk add --no-cache curl
    - 'curl -s -X POST "$RENDER_DEPLOY_HOOK_URL"'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - server/**/*
  when: manual
  allow_failure: true
